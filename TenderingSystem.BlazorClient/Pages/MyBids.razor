@page "/my-bids"
@using TenderingSystem.Shared.Models.Bids
@using TenderingSystem.BlazorClient.Services
@inject BidService BidService
@inject ISnackbar Snackbar
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Supplier")]

<PageTitle>Ø¹Ø±ÙˆØ¶ÙŠ Ø§Ù„ÙÙ†ÙŠØ© ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ©</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">ğŸ’¼ Ø¹Ø±ÙˆØ¶ÙŠ</MudText>

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
}
else if (_bids.Count == 0)
{
    <MudAlert Severity="Severity.Info">Ù„Ù… ØªÙ‚Ù… Ø¨ØªÙ‚Ø¯ÙŠÙ… Ø£ÙŠ Ø¹Ø±ÙˆØ¶ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</MudAlert>
}
else
{
    <MudTable Items="@_bids" Hover="true" Striped="true" Bordered="true" Elevation="2">
        <HeaderContent>
            <MudTh>Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ©</MudTh>
            <MudTh>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ©</MudTh>
            <MudTh>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…</MudTh>
            <MudTh>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚Ø¯Ù…</MudTh>
            <MudTh>Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙÙ†ÙŠ</MudTh>
            <MudTh>Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ©">@context.TenderId.ToString().Substring(0, 8)</MudTd>
            <MudTd DataLabel="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ©">
                <MudLink Href="@($"/tenders/{context.TenderId}")">@context.TenderTitle</MudLink>
            </MudTd>
            <MudTd DataLabel="ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…">@context.SubmissionDate.ToString("yyyy-MM-dd HH:mm")</MudTd>
            <MudTd DataLabel="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚Ø¯Ù…">@context.SubmittedPrice.ToString("C")</MudTd>
            <MudTd DataLabel="Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙÙ†ÙŠ">
                <MudLink Href="@context.TechnicalProposalUrl" Target="_blank" Color="Color.Info">
                    <MudIcon Icon="@Icons.Material.Filled.OpenInNew" Size="Size.Small" Class="mr-1" /> Ø¹Ø±Ø¶
                </MudLink>
            </MudTd>
            <MudTd DataLabel="Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶">
                <MudChip T="string" Color="@GetStatusColor(context.Status)">@GetStatusText(context.Status)</MudChip>
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
}

@code {
    private List<BidDto> _bids = new();
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadBids();
    }

    private async Task LoadBids()
    {
        _loading = true;
        try
        {
            _bids = await BidService.GetMyBidsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private Color GetStatusColor(string status) => status switch
    {
        "Submitted" => Color.Warning,
        "Accepted" => Color.Success,
        "Rejected" => Color.Error,
        _ => Color.Default
    };

    private string GetStatusText(string status) => status switch
    {
        "Submitted" => "Ù‚ÙŠØ¯ Ø§Ù„Ø¯Ø±Ø§Ø³Ø©",
        "Accepted" => "Ù…Ù‚Ø¨ÙˆÙ„",
        "Rejected" => "Ù…Ø±ÙÙˆØ¶",
        _ => status
    };
}
