@page "/suppliers"
@using TenderingSystem.Shared.Models.Suppliers
@using TenderingSystem.BlazorClient.Services
@inject SupplierService SupplierService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<PageTitle>Ø§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ†</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">ğŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</MudText>

<MudPaper Elevation="2" Class="pa-4 mb-4">
    <MudGrid>
        <MudItem xs="12" md="6">
            <MudTextField @bind-Value="_searchText" Label="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯"
                          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                          Variant="Variant.Outlined" Immediate="true" />
        </MudItem>
        <MudItem xs="12" md="3">
            <MudSelect @bind-Value="_filterStatus" Label="ØªØµÙÙŠØ© Ø¨Ø§Ù„Ø­Ø§Ù„Ø©" Variant="Variant.Outlined">
                <MudSelectItem Value="@("")">Ø§Ù„ÙƒÙ„</MudSelectItem>
                <MudSelectItem Value="@("Registered")">Ù…Ø³Ø¬Ù‘Ù„</MudSelectItem>
                <MudSelectItem Value="@("AiSuggested")">Ù…Ù‚ØªØ±Ø­ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</MudSelectItem>
                <MudSelectItem Value="@("Verified")">Ù…ÙˆØ«Ù‘Ù‚</MudSelectItem>
                <MudSelectItem Value="@("Blocked")">Ù…Ø­Ø¸ÙˆØ±</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="3" Class="d-flex align-center">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                       OnClick="OpenCreateDialog" FullWidth="true">
                Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
}
else if (_suppliers.Count == 0)
{
    <MudAlert Severity="Severity.Info">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ±Ø¯ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯" Ù„Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ù…ÙˆØ±Ø¯.</MudAlert>
}
else
{
    <MudTable Items="@FilteredSuppliers" Hover="true" Striped="true" Bordered="true"
              Elevation="2" Dense="false">
        <HeaderContent>
            <MudTh>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</MudTh>
            <MudTh>Ø§Ù„ÙØ¦Ø§Øª</MudTh>
            <MudTh>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</MudTh>
            <MudTh>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</MudTh>
            <MudTh>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</MudTh>
            <MudTh>Ø§Ù„Ø­Ø§Ù„Ø©</MudTh>
            <MudTh>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©">@context.CompanyName</MudTd>
            <MudTd DataLabel="Ø§Ù„ÙØ¦Ø§Øª">
                @if (context.CategoryNames != null && context.CategoryNames.Any())
                {
                    foreach (var cat in context.CategoryNames)
                    {
                        <MudChip T="string" Color="Color.Info" Size="Size.Small" Class="mr-1">@cat</MudChip>
                    }
                }
                else
                {
                    <MudText Typo="Typo.body2" Color="Color.Surface">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</MudText>
                }
            </MudTd>
            <MudTd DataLabel="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">@context.Email</MudTd>
            <MudTd DataLabel="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">@context.PhoneNumber</MudTd>
            <MudTd DataLabel="Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
                @if (!string.IsNullOrEmpty(context.WebsiteUrl))
                {
                    <MudLink Href="@context.WebsiteUrl" Target="_blank">@context.WebsiteUrl</MudLink>
                }
            </MudTd>
            <MudTd DataLabel="Ø§Ù„Ø­Ø§Ù„Ø©">
                <MudChip T="string" Color="@GetStatusColor(context.Status)" Size="Size.Small">
                    @GetStatusText(context.Status)
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Warning" Size="Size.Small"
                               OnClick="@(() => OpenEditDialog(context))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                               OnClick="@(() => AskDeleteConfirm(context))" />
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
}

@code {
    private List<SupplierDto> _suppliers = new();
    private bool _loading = true;
    private string _searchText = string.Empty;
    private string _filterStatus = string.Empty;
    private SupplierDto? _supplierToDelete;
    private bool _showDeleteConfirm = false;

    private IEnumerable<SupplierDto> FilteredSuppliers => _suppliers
        .Where(s => (string.IsNullOrEmpty(_searchText) ||
                     s.CompanyName.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                     s.Email.Contains(_searchText, StringComparison.OrdinalIgnoreCase)) &&
                    (string.IsNullOrEmpty(_filterStatus) || s.Status == _filterStatus));

    protected override async Task OnInitializedAsync()
    {
        await LoadSuppliers();
    }

    private async Task LoadSuppliers()
    {
        _loading = true;
        try
        {
            _suppliers = await SupplierService.GetAllSuppliersAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OpenCreateDialog()
    {
        var parameters = new DialogParameters();
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<SupplierFormDialog>("Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÙŠØ¯", parameters, options);
        var result = await dialog.Result;
        if (!result!.Canceled) await LoadSuppliers();
    }

    private async Task OpenEditDialog(SupplierDto supplier)
    {
        var parameters = new DialogParameters { ["Supplier"] = supplier };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<SupplierFormDialog>("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯", parameters, options);
        var result = await dialog.Result;
        if (!result!.Canceled) await LoadSuppliers();
    }

    private void AskDeleteConfirm(SupplierDto supplier)
    {
        _supplierToDelete = supplier;
        _showDeleteConfirm = true;
        StateHasChanged();
    }

    private async Task ConfirmDelete()
    {
        _showDeleteConfirm = false;
        if (_supplierToDelete == null) return;

        var success = await SupplierService.DeleteSupplierAsync(_supplierToDelete.Id);
        Snackbar.Add(success ? "ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¨Ù†Ø¬Ø§Ø­" : "ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ±Ø¯",
                     success ? Severity.Success : Severity.Error);
        if (success) await LoadSuppliers();
        _supplierToDelete = null;
    }

    private Color GetStatusColor(string status) => status switch
    {
        "Registered" => Color.Info,
        "AiSuggested" => Color.Secondary,
        "Verified" => Color.Success,
        "Blocked" => Color.Error,
        _ => Color.Default
    };

    private string GetStatusText(string status) => status switch
    {
        "Registered" => "Ù…Ø³Ø¬Ù‘Ù„",
        "AiSuggested" => "Ù…Ù‚ØªØ±Ø­ AI",
        "Verified" => "Ù…ÙˆØ«Ù‘Ù‚",
        "Blocked" => "Ù…Ø­Ø¸ÙˆØ±",
        _ => status
    };
}
