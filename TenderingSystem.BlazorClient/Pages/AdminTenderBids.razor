@page "/tenders/{TenderId:guid}/bids"
@using TenderingSystem.Shared.Models.Bids
@using TenderingSystem.BlazorClient.Services
@inject BidService BidService
@inject ISnackbar Snackbar
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]

<PageTitle>Ø¥Ø¯Ø§Ø±Ø© Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ©</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">ğŸ“‹ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ©</MudText>

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
}
else if (_bids.Count == 0)
{
    <MudAlert Severity="Severity.Info">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…Ù‚Ø¯Ù…Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</MudAlert>
}
else
{
    <MudTable Items="@_bids" Hover="true" Striped="true" Bordered="true" Elevation="2">
        <HeaderContent>
            <MudTh>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶</MudTh>
            <MudTh>Ø§Ù„Ù…ÙˆØ±Ø¯</MudTh>
            <MudTh>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…</MudTh>
            <MudTh>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚Ø¯Ù…</MudTh>
            <MudTh>Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙÙ†ÙŠ</MudTh>
            <MudTh>Ø§Ù„Ø­Ø§Ù„Ø©</MudTh>
            <MudTh>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶">@context.Id.ToString().Substring(0, 8)</MudTd>
            <MudTd DataLabel="Ø§Ù„Ù…ÙˆØ±Ø¯">@context.SupplierName</MudTd>
            <MudTd DataLabel="ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…">@context.SubmissionDate.ToString("yyyy-MM-dd HH:mm")</MudTd>
            <MudTd DataLabel="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚Ø¯Ù…">@context.SubmittedPrice.ToString("C")</MudTd>
            <MudTd DataLabel="Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙÙ†ÙŠ">
                <MudLink Href="@context.TechnicalProposalUrl" Target="_blank" Color="Color.Info">
                    <MudIcon Icon="@Icons.Material.Filled.OpenInNew" Size="Size.Small" Class="mr-1" /> Ø¹Ø±Ø¶
                </MudLink>
            </MudTd>
            <MudTd DataLabel="Ø§Ù„Ø­Ø§Ù„Ø©">
                <MudChip T="string" Color="@GetStatusColor(context.Status)">@GetStatusText(context.Status)</MudChip>
            </MudTd>
            <MudTd DataLabel="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                @if (context.Status == "Submitted")
                {
                    <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small" 
                               OnClick="@(() => AwardBid(context.Id))" Disabled="_processingId == context.Id">
                        @if (_processingId == context.Id)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        }
                        Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¶
                    </MudButton>
                }
            </MudTd>
        </RowTemplate>
    </MudTable>
}

@code {
    [Parameter] public Guid TenderId { get; set; }
    private List<BidDto> _bids = new();
    private bool _loading = true;
    private Guid? _processingId = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadBids();
    }

    private async Task LoadBids()
    {
        _loading = true;
        try
        {
            _bids = await BidService.GetBidsForTenderAsync(TenderId);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ø®Ø·Ø£: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task AwardBid(Guid bidId)
    {
        _processingId = bidId;
        try
        {
            await BidService.AwardBidAsync(bidId);
            Snackbar.Add("ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†Ø¬Ø§Ø­", Severity.Success);
            await LoadBids(); // Refresh the list
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ø®Ø·Ø£: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processingId = null;
        }
    }

    private Color GetStatusColor(string status) => status switch
    {
        "Submitted" => Color.Warning,
        "Accepted" => Color.Success,
        "Rejected" => Color.Error,
        _ => Color.Default
    };

    private string GetStatusText(string status) => status switch
    {
        "Submitted" => "Ù‚ÙŠØ¯ Ø§Ù„Ø¯Ø±Ø§Ø³Ø©",
        "Accepted" => "Ù…Ù‚Ø¨ÙˆÙ„",
        "Rejected" => "Ù…Ø±ÙÙˆØ¶",
        _ => status
    };
}
