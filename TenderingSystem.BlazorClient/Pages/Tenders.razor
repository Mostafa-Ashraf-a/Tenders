@page "/tenders"
@using TenderingSystem.Shared.Models.Tenders
@using TenderingSystem.BlazorClient.Services
@inject TenderService TenderService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<PageTitle>Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª</MudText>

<MudPaper Elevation="2" Class="pa-4 mb-4">
    <MudGrid>
        <MudItem xs="12" md="6">
            <MudTextField @bind-Value="_searchText" Label="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„ÙØ¦Ø©"
                          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                          Variant="Variant.Outlined" Immediate="true" />
        </MudItem>
        <MudItem xs="12" md="3">
            <MudSelect @bind-Value="_filterStatus" Label="ØªØµÙÙŠØ© Ø¨Ø§Ù„Ø­Ø§Ù„Ø©" Variant="Variant.Outlined">
                <MudSelectItem Value="@("")">Ø§Ù„ÙƒÙ„</MudSelectItem>
                <MudSelectItem Value="@("Draft")">Ù…Ø³ÙˆØ¯Ø©</MudSelectItem>
                <MudSelectItem Value="@("Published")">Ù…Ù†Ø´ÙˆØ±Ø©</MudSelectItem>
                <MudSelectItem Value="@("UnderEvaluation")">ØªØ­Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</MudSelectItem>
                <MudSelectItem Value="@("Awarded")">Ù…ÙØ±Ø³Ù‰</MudSelectItem>
                <MudSelectItem Value="@("Cancelled")">Ù…Ù„ØºØ§Ø©</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="3" Class="d-flex align-center">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                       OnClick="OpenCreateDialog" FullWidth="true">
                Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø§Ù‚ØµØ©
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
}
else if (_tenders.Count == 0)
{
    <MudAlert Severity="Severity.Info">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ù‚ØµØ§Øª Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø§Ù‚ØµØ©" Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙˆÙ„ Ù…Ù†Ø§Ù‚ØµØ©.</MudAlert>
}
else
{
    <MudTable Items="@FilteredTenders" Hover="true" Striped="true" Bordered="true"
              Elevation="2" Dense="false">
        <HeaderContent>
            <MudTh>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</MudTh>
            <MudTh>Ø§Ù„ÙØ¦Ø©</MudTh>
            <MudTh>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø±</MudTh>
            <MudTh>Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯</MudTh>
            <MudTh>Ø§Ù„Ø­Ø§Ù„Ø©</MudTh>
            <MudTh>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">@context.Title</MudTd>
            <MudTd DataLabel="Ø§Ù„ÙØ¦Ø©">@context.CategoryName</MudTd>
            <MudTd DataLabel="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø±">@context.PublishDate.ToString("dd/MM/yyyy")</MudTd>
            <MudTd DataLabel="Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯">@context.ClosingDate.ToString("dd/MM/yyyy")</MudTd>
            <MudTd DataLabel="Ø§Ù„Ø­Ø§Ù„Ø©">
                <MudChip T="string" Color="@GetStatusColor(context.Status)" Size="Size.Small">
                    @GetStatusText(context.Status)
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                @if (context.Status == "Draft")
                {
                    <MudIconButton Icon="@Icons.Material.Filled.Send" Color="Color.Success" Size="Size.Small"
                                   OnClick="@(() => PublishTender(context))" />
                }
                <MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Info" Size="Size.Small"
                               OnClick="@(() => ViewDetails(context.Id))" />
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Warning" Size="Size.Small"
                               OnClick="@(() => OpenEditDialog(context))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                               OnClick="@(() => AskDeleteConfirm(context))" />
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
}

@if (_showDeleteConfirm && _tenderToDelete != null)
{
    <MudMessageBox @ref="_messageBox" Title="ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù" CancelText="Ø¥Ù„ØºØ§Ø¡">
        <MessageContent>
            Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ©: <strong>@_tenderToDelete.Title</strong>ØŸ
        </MessageContent>
        <YesButton>
            <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="ConfirmDelete">Ø­Ø°Ù</MudButton>
        </YesButton>
    </MudMessageBox>
}

@code {
    private List<TenderDto> _tenders = new();
    private bool _loading = true;
    private string _searchText = string.Empty;
    private string _filterStatus = string.Empty;
    private TenderDto? _tenderToDelete;
    private bool _showDeleteConfirm = false;
    private MudMessageBox? _messageBox;

    private IEnumerable<TenderDto> FilteredTenders => _tenders
        .Where(t => (string.IsNullOrEmpty(_searchText) ||
                     t.Title.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                     t.CategoryName.Contains(_searchText, StringComparison.OrdinalIgnoreCase)) &&
                    (string.IsNullOrEmpty(_filterStatus) || t.Status == _filterStatus));

    protected override async Task OnInitializedAsync()
    {
        await LoadTenders();
    }

    private async Task LoadTenders()
    {
        _loading = true;
        try
        {
            _tenders = await TenderService.GetAllTendersAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void ViewDetails(Guid id) => Navigation.NavigateTo($"/tenders/{id}");

    private async Task OpenCreateDialog()
    {
        var parameters = new DialogParameters();
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<TenderFormDialog>("Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø§Ù‚ØµØ© Ø¬Ø¯ÙŠØ¯Ø©", parameters, options);
        var result = await dialog.Result;
        if (!result!.Canceled)
            await LoadTenders();
    }

    private async Task OpenEditDialog(TenderDto tender)
    {
        var parameters = new DialogParameters { ["Tender"] = tender };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<TenderFormDialog>("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ©", parameters, options);
        var result = await dialog.Result;
        if (!result!.Canceled)
            await LoadTenders();
    }

    private void AskDeleteConfirm(TenderDto tender)
    {
        _tenderToDelete = tender;
        _showDeleteConfirm = true;
        StateHasChanged();
    }

    private async Task ConfirmDelete()
    {
        _showDeleteConfirm = false;
        if (_tenderToDelete == null) return;

        var success = await TenderService.DeleteTenderAsync(_tenderToDelete.Id);
        Snackbar.Add(success ? "ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ© Ø¨Ù†Ø¬Ø§Ø­" : "ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ©",
                     success ? Severity.Success : Severity.Error);
        if (success) await LoadTenders();
        _tenderToDelete = null;
    }

    private async Task PublishTender(TenderDto tender)
    {
        var parameters = new DialogParameters();
        parameters.Add("ContentText", $"Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø´Ø± Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ© '{tender.Title}'ØŸ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†.");
        parameters.Add("ButtonText", "Ù†Ø´Ø±");
        parameters.Add("Color", Color.Success);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };

        var dialog = await DialogService.ShowAsync<MudMessageBox>("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ø´Ø±", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            var success = await TenderService.PublishTenderAsync(tender.Id);
            if (success)
            {
                Snackbar.Add("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ© ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­", Severity.Success);
                await LoadTenders();
            }
            else
            {
                Snackbar.Add("ÙØ´Ù„ ÙÙŠ Ù†Ø´Ø± Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ©", Severity.Error);
            }
        }
    }

    private Color GetStatusColor(string status) => status switch
    {
        "Draft" => Color.Default,
        "Published" => Color.Success,
        "UnderEvaluation" => Color.Warning,
        "Awarded" => Color.Primary,
        "Cancelled" => Color.Error,
        "Archived" => Color.Dark,
        _ => Color.Default
    };

    private string GetStatusText(string status) => status switch
    {
        "Draft" => "Ù…Ø³ÙˆØ¯Ø©",
        "Published" => "Ù…Ù†Ø´ÙˆØ±Ø©",
        "UnderEvaluation" => "ØªØ­Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…",
        "Awarded" => "Ù…ÙØ±Ø³Ù‰",
        "Cancelled" => "Ù…Ù„ØºØ§Ø©",
        "Archived" => "Ù…Ø¤Ø±Ø´ÙØ©",
        _ => status
    };
}
