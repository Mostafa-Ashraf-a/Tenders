@page "/categories"
@using TenderingSystem.Shared.Models.Categories
@using TenderingSystem.BlazorClient.Services
@inject CategoryService CategoryService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<PageTitle>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">ğŸ·ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª</MudText>

<MudPaper Elevation="2" Class="pa-4 mb-4">
    <MudGrid>
        <MudItem xs="12" md="8">
            <MudTextField @bind-Value="_searchText" Label="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©"
                          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                          Variant="Variant.Outlined" Immediate="true" />
        </MudItem>
        <MudItem xs="12" md="4" Class="d-flex align-center">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                       OnClick="OpenCreateDialog" FullWidth="true">
                Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø©
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
}
else if (_categories.Count == 0)
{
    <MudAlert Severity="Severity.Info">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø©" Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©.</MudAlert>
}
else
{
    <MudTable Items="@FilteredCategories" Hover="true" Striped="true" Bordered="true" Elevation="2" Dense="false">
        <HeaderContent>
            <MudTh>Ø§Ù„Ø§Ø³Ù…</MudTh>
            <MudTh>Ø§Ù„ÙˆØµÙ</MudTh>
            <MudTh>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Ø§Ù„Ø§Ø³Ù…">@context.Name</MudTd>
            <MudTd DataLabel="Ø§Ù„ÙˆØµÙ">@context.Description</MudTd>
            <MudTd DataLabel="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Warning" Size="Size.Small"
                               OnClick="@(() => OpenEditDialog(context))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                               OnClick="@(() => AskDeleteConfirm(context))" />
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
}

@code {
    private List<CategoryDto> _categories = new();
    private bool _loading = true;
    private string _searchText = string.Empty;

    private IEnumerable<CategoryDto> FilteredCategories => _categories
        .Where(c => string.IsNullOrEmpty(_searchText) ||
                    c.Name.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                    c.Description.Contains(_searchText, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
    }

    private async Task LoadCategories()
    {
        _loading = true;
        try
        {
            _categories = await CategoryService.GetAllCategoriesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OpenCreateDialog()
    {
        var parameters = new DialogParameters();
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<CategoryFormDialog>("Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©", parameters, options);
        var result = await dialog.Result;
        if (!result!.Canceled)
            await LoadCategories();
    }

    private async Task OpenEditDialog(CategoryDto category)
    {
        var parameters = new DialogParameters { ["Category"] = category };
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<CategoryFormDialog>("ØªØ¹Ø¯ÙŠÙ„ ÙØ¦Ø©", parameters, options);
        var result = await dialog.Result;
        if (!result!.Canceled)
            await LoadCategories();
    }

    private async Task AskDeleteConfirm(CategoryDto category)
    {
        var parameters = new DialogParameters();
        parameters.Add("ContentText", $"Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙØ¦Ø© '{category.Name}'ØŸ");
        parameters.Add("ButtonText", "Ø­Ø°Ù");
        parameters.Add("Color", Color.Error);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };

        var dialog = await DialogService.ShowAsync<MudMessageBox>("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            var success = await CategoryService.DeleteCategoryAsync(category.Id);
            if (success)
            {
                Snackbar.Add("ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­", Severity.Success);
                await LoadCategories();
            }
            else
            {
                Snackbar.Add("ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©", Severity.Error);
            }
        }
    }
}
