@page "/tenders/{Id:guid}"
@using TenderingSystem.Shared.Models.Tenders
@using TenderingSystem.BlazorClient.Services
@inject TenderService TenderService
@inject BidService BidService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<PageTitle>تفاصيل المناقصة</PageTitle>

<MudBreadcrumbs Items="_breadcrumbs" Class="mb-4" />

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
}
else if (_tender == null)
{
    <MudAlert Severity="Severity.Error">المناقصة غير موجودة.</MudAlert>
}
else
{
    <MudCard Elevation="3">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h5">@_tender.Title</MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudChip T="string" Color="@GetStatusColor(_tender.Status)">@GetStatusText(_tender.Status)</MudChip>
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent>
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle1" Color="Color.Secondary">الوصف</MudText>
                    <MudText>@_tender.Description</MudText>
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudText Typo="Typo.subtitle1" Color="Color.Secondary">الفئة</MudText>
                    <MudText>@_tender.CategoryName</MudText>
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudText Typo="Typo.subtitle1" Color="Color.Secondary">تاريخ النشر</MudText>
                    <MudText>@_tender.PublishDate.ToString("dd MMMM yyyy")</MudText>
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudText Typo="Typo.subtitle1" Color="Color.Secondary">آخر موعد للتقديم</MudText>
                    <MudText>@_tender.ClosingDate.ToString("dd MMMM yyyy")</MudText>
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudText Typo="Typo.subtitle1" Color="Color.Secondary">استهداف AI</MudText>
                    <MudText>@(_tender.HasAiTargeting ? "✅ مفعّل" : "❌ غير مفعّل")</MudText>
                </MudItem>
            </MudGrid>
        </MudCardContent>
        <MudCardActions>
            <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.ArrowBack"
                       OnClick="@(() => Navigation.NavigateTo("/tenders"))">
                رجوع للقائمة
            </MudButton>
            <MudSpacer />
            <AuthorizeView Roles="Admin">
                <Authorized>
                    <MudButton Variant="Variant.Filled" Color="Color.Info" StartIcon="@Icons.Material.Filled.People"
                               OnClick="@(() => Navigation.NavigateTo($"/tenders/{Id}/bids"))">
                        إدارة العروض
                    </MudButton>
                </Authorized>
            </AuthorizeView>
            <AuthorizeView Roles="Supplier">
                <Authorized>
                    @if (_tender.Status == "Published" && DateTime.UtcNow <= _tender.ClosingDate)
                    {
                        if (_hasBid)
                        {
                            <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Check" Disabled="true">
                                تم العرض مسبقاً
                            </MudButton>
                        }
                        else
                        {
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.AttachMoney"
                                       OnClick="OpenBidDialog">
                                تقديم عرض
                            </MudButton>
                        }
                    }
                </Authorized>
            </AuthorizeView>
        </MudCardActions>
    </MudCard>
}

@code {
    [Parameter] public Guid Id { get; set; }
    [Inject] private IDialogService DialogService { get; set; } = default!;

    private TenderDto? _tender;
    private bool _loading = true;
    private bool _hasBid = false;

    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("الرئيسية", href: "/"),
        new BreadcrumbItem("المناقصات", href: "/tenders"),
        new BreadcrumbItem("التفاصيل", href: null, disabled: true)
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _tender = await TenderService.GetTenderByIdAsync(Id);
            
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            if (authState.User.IsInRole("Supplier"))
            {
                _hasBid = await BidService.HasSupplierBidAsync(Id);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"خطأ: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private Color GetStatusColor(string status) => status switch
    {
        "Draft" => Color.Default,
        "Published" => Color.Success,
        "UnderEvaluation" => Color.Warning,
        "Awarded" => Color.Primary,
        "Cancelled" => Color.Error,
        "Archived" => Color.Dark,
        _ => Color.Default
    };

    private string GetStatusText(string status) => status switch
    {
        "Draft" => "مسودة",
        "Published" => "منشورة",
        "UnderEvaluation" => "تحت التقييم",
        "Awarded" => "مُرسى",
        "Cancelled" => "ملغاة",
        "Archived" => "مؤرشفة",
        _ => status
    };

    private async Task OpenBidDialog()
    {
        var parameters = new DialogParameters { ["TenderId"] = _tender!.Id };
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<BidFormDialog>("تقديم عرض فني ومالي", parameters, options);
        var result = await dialog.Result;
        
        if (!result!.Canceled)
        {
            // Optionally redirect to My Bids page
            Navigation.NavigateTo("/my-bids");
        }
    }
}
